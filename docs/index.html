<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="css/pico.min.css" />
        <link rel="stylesheet" href="css/choices.min.css" />
        <link rel="stylesheet" href="css/styles.css" />
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>&#x1f35f;</text></svg>">
        <title>McDonald's Receipt Validator (UK)</title>
    </head>
    <body>
        <main class="container">
            <h2>McDonald's Receipt Validator (UK)</h2>

            <form>
                <fieldset>
                    <label>Store</label>
                    <select name="store_id">
                        <option value="">Select a store</option>
                    </select>
                </fieldset>

                <fieldset>
                    <label>
                        Order ID
                        <input type="number" pattern="[0-9]*" min="0" name="order_id" required />
                    </label>
                </fieldset>

                <fieldset>
                    <label>
                        Purchased
                        <input type="datetime-local" min="2016-02-01T00:00" name="purchased" required />
                    </label>
                </fieldset>

                <fieldset>
                    <label>
                        Reg
                        <input type="number" pattern="[0-9]*" min="0" name="reg" />
                        <small>Leave blank to use the default value of 20.</small>
                    </label>
                </fieldset>

                <fieldset>
                    <input type="submit" value="Generate" />
                </fieldset>
            </form>

            <hr />

            <section class="code">
                <h4>Entry codes (10 random)</h4>
                <div id="code">&nbsp;</div>
            </section>
            <hr />
        </main>

        <script src="js/get_code.js"></script>
        <script src="js/choices.min.js"></script>
        <script>
            (async () => {
                new Choices("[name='store_id']", {
                    choices: await getStores(),
                    itemSelectText: "",
                    maxItemCount: 1,
                    searchResultLimit: 10,
                });

                document.querySelector("form").addEventListener("submit", (e) => {
                    e.preventDefault();

                    const codeContainer = document.querySelector("#code");
                    const form = new FormData(e.target);
                    const storeId = parseInt(form.get("store_id"), 10);
                    const orderId = parseInt(form.get("order_id"), 10);
                    const purchased = form.get("purchased");
                    const reg = form.get("reg") ? parseInt(form.get("reg"), 10) : 20;
                    const isValid = [storeId, orderId, reg].every(val => !isNaN(val));

                    if (isValid && purchased) {
                        const code = generateCode(storeId, orderId, purchased, reg);
                        codeContainer.innerText = code;
                    } else {
                        alert("Invalid details");
                    }
                });

                // Auto-generate 10 random codes on load using reg=7
                async function generateRandomCodes(count = 10) {
                    const codeContainer = document.querySelector('#code');
                    const stores = await getStores();

                    if (!stores || stores.length === 0) {
                        codeContainer.innerText = 'No stores available';
                        return;
                    }

                    const list = document.createElement('ol');
                    for (let i = 0; i < count; i++) {
                        // pick random store entry (value is the id string)
                        const store = stores[Math.floor(Math.random() * stores.length)];
                        const storeId = parseInt(store.value, 10);

                        // random order id between 0 and 99
                        const orderId = Math.floor(Math.random() * 100);

                        // random purchased time within the last week
                        const now = new Date();
                        const oneWeekMs = 7 * 24 * 60 * 60 * 1000;
                        const randomPast = new Date(now.getTime() - Math.floor(Math.random() * oneWeekMs));

                        const purchasedLocal = new Date(randomPast.getTime() - (randomPast.getTimezoneOffset() * 60000));
                        const purchasedIso = purchasedLocal.toISOString().slice(0,16);

                        const code = generateCode(storeId, orderId, purchasedIso, 7);

                        const item = document.createElement('li');
                        item.innerText = `${code} — ${store.label} — order ${String(orderId).padStart(3,'0')} — ${randomPast.toLocaleString()}`;
                        list.appendChild(item);
                    }

                    // replace container contents
                    codeContainer.innerHTML = '';
                    codeContainer.appendChild(list);
                }

                // run after choices has been initialised above
                // small delay to ensure stores are loaded into the select
                setTimeout(() => generateRandomCodes(10), 300);
            })();

            function getStores() {
                return new Promise(resolve => {
                    fetch("https://raw.githubusercontent.com/liamglasson/bigmac/main/assets/stores.tsv")
                        .then(response => response.text())
                        .then(data => {
                            resolve(data.split("\n").map(row => {
                                const [id, name] = row.split("\t");
                                return {
                                    value: id,
                                    label: `${name} (${id})`,
                                };
                            }));
                        })
                        .catch(() => alert("Error loading stores"));
                });
            }
        </script>
    </body>
</html>